var W=Object.defineProperty;var j=r=>{throw TypeError(r)};var _=(r,e,t)=>e in r?W(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var U=(r,e,t)=>_(r,typeof e!="symbol"?e+"":e,t),F=(r,e,t)=>e.has(r)||j("Cannot "+t);var a=(r,e,t)=>(F(r,e,"read from private field"),t?t.call(r):e.get(r)),c=(r,e,t)=>e.has(r)?j("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t);import{s as h,a as C,g,c as p}from"./QwNgEtIe.js";import{E as X,e as R,t as m,U as B,S as Y}from"./YCu01eox.js";import{p as z}from"./BNMsK8YA.js";import{g as A}from"./C0qwNRwb.js";const J=z,M=new Map;class l{constructor(e){this.url=e}async post(e={}){let s=await(await fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json","X-Request-Token":i.getValue("token")},body:JSON.stringify(e)})).json();return(s.code===6||s.code===3)&&(O.isPublicRoutes()||await i.redirect("/")),s}}var k,x,S,E,P;class G{constructor(e){c(this,k,h(!1));U(this,"data",[]);c(this,x,h(!1));c(this,S,h(null));c(this,E,h(!1));c(this,P,h(C(Date.now())));this.url=e}get loading(){return g(a(this,k))}set loading(e){p(a(this,k),e,!0)}get error(){return g(a(this,x))}set error(e){p(a(this,x),e,!0)}get errorMsg(){return g(a(this,S))}set errorMsg(e){p(a(this,S),e,!0)}get done(){return g(a(this,E))}set done(e){p(a(this,E),e,!0)}get updated(){return g(a(this,P))}set updated(e){p(a(this,P),e,!0)}async post(e={}){if(!this.updated||this.done||this.loading)return;this.loading=!0;let t=await fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json","X-Request-Token":i.getValue("token")},body:JSON.stringify(e)});if(t.ok){let{code:s,data:n,msg:o}=await t.json();(s===6||s===3)&&(O.isPublicRoutes()||(window.location.href="/")),this.data=n,s===0?(this.error=!1,this.loading=!1):(this.error=this,this.errorMsg=o),this.done=!0,R.emit("edgesDone")}else this.data=null,this.error=!0,this.errorMsg=t.statusText,this.loading=!1,this.done=!1,R.emit("edgesDone")}async reload(e=[]){this.done=!1,this.data=[],await this.post(e)}}k=new WeakMap,x=new WeakMap,S=new WeakMap,E=new WeakMap,P=new WeakMap;class H extends X{constructor(){var e,t;super(),(e=window.electron)==null||e.onPageRequest((s,{id:n,code:o,data:d,msg:y})=>{if(M.has(n)){let{resolve:w,reject:v}=M.get(n);o===0?w(d):v(y)}}),(t=window.electron)==null||t.onPageEvent((s,{type:n,data:o})=>{this.emit(n,o)})}request(e,t){if(!window.electron)return Promise.resolve(null);let s=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return new Promise((n,o)=>{window.electron.request({id:s,type:e,params:t}),M.set(s,{resolve:n,reject:o})})}isElectronEvn(){return window.electron}}var b;class Q{constructor(e){c(this,b,h(C(Date.now())));this.electron=e,this.states={},this.electron.on("proxiesUpdate",async t=>{this.states=t||{},this.update()}),this.electron.on("kubeTunnelReady",()=>{R.emit("kubeTunnelReady")}),e.isElectronEvn()&&e.request("getServiceTunnelServerInfo").then(t=>{Object.assign(this.states,t||{})})}get updated(){return g(a(this,b))}set updated(e){p(a(this,b),e,!0)}get data(){let e=i.getValue("proxies")||[];return e.forEach(t=>t.status="Disconnect"),Reflect.ownKeys(this.states).forEach(t=>{let s=e.find(n=>n.id===t);if(s){let{state:n}=this.states[t];s.status=n?"Running":"Disconnect"}}),e}keep(){return this.updated?{done(e){e&&e()}}:null}update(){this.updated=Date.now()}getProxy(e){return this.data.find(t=>t.id===e)}createProxy(e){let t=i.getValue("proxies");return(t||[]).find(s=>s.name===e.name)?!1:(t||(t=[]),t.push(e),i.setValue("proxies",t),this.updated=Date.now(),!0)}async updateProxy(e){await this.stopProxyServer(e.id);let t=i.getValue("proxies"),s=(t||[]).findIndex(n=>n.id===e.id);s!==-1&&(t[s]=e,i.setValue("proxies",t),this.updated=Date.now())}async removeProxy(e){await this.stopProxyServer(e);let t=i.getValue("proxies");i.setValue("proxies",(t||[]).filter(s=>s.id!==e)),this.updated=Date.now()}async startProxyServer(e){let t=this.data.find(o=>o.id===e),s={host:t.target.host,port:t.target.port};if(t.serviceType==="kube"){let{code:o,msg:d,body:y}=await N.post({edgeId:t.cluster==="central"?null:t.cluster,serviceName:"synterix-kube-proxy",path:"/kube/config",headers:{"Content-Type":"application/json;charset=UTF-8"}});if(o!==0)m.error(d);else{let{code:w,msg:v,data:D}=JSON.parse(y);w!==0&&m.error(v),s.host=D.host,s.port=D.port}}t.cluster!=="central"&&(s.edgeId=t.cluster);let n=await re.post(s);if(n.code!==0){m.error(n.msg);return}if(u.isElectronEvn()&&t&&f.done){let o=f.data.find(d=>d.clusterId===t.cluster);if(o){let d={id:t.id,cluster:t.cluster,token:o.token,target:t.target,localPort:t.localPort};t.cluster==="central"&&(d.token=i.getValue("token")),await u.request("startProxyTunnel",d)}}}async stopProxyServer(e){if(u.isElectronEvn()){let{code:t,msg:s}=await u.request("stopProxyTunnel",{id:e});t!==0&&m.error(s)}}async startKubeTunnelServer(e,t){if(e==="central"){u.isElectronEvn()&&await u.request("startKubeTunnelServer",{type:e,token:i.getValue("token")});return}let s=f.data.find(n=>n.edgeId===t);s&&u.isElectronEvn()&&await u.request("startKubeTunnelServer",{type:e,token:i.getValue("token"),linkEdgeId:s.edgeId})}async getKubeTunnelServerInfo(){return u.isElectronEvn()?await u.request("getKubeTunnelServerInfo",{}):null}async downloadKubeconfig(e){let t=this.getProxy(e),{code:s,msg:n,body:o}=await N.post({edgeId:t.cluster==="central"?null:t.cluster,serviceName:"synterix-kube-proxy",path:"/kube/config",headers:{"Content-Type":"application/json;charset=UTF-8"}});if(s!==0)m.error(n);else{let{code:d,msg:y,data:w}=JSON.parse(o);d!==0&&m.error(y);let{ca:v,token:D,namespace:$}=w,L=`apiVersion: v1
clusters:
- cluster:
    insecure-skip-tls-verify: true
    certificate-authority-data: ${v}
    server: https://127.0.0.1:${t.localPort}
  name: default-cluster
contexts:
- context:
    cluster: default-cluster
    user: default-user
    namespace: ${$}
  name: default-context
current-context: default-context
kind: Config
preferences: {}
users:
- name: default-user
  user:
    token: ${D}`;B.downloadAsYAML(L,"kubeconfig")}}}b=new WeakMap;var T;class Z{constructor(){c(this,T,h("dark"));{let e=document.body.getAttribute("data-theme");this.theme=e}}get theme(){return g(a(this,T))}set theme(e){p(a(this,T),e,!0)}isDark(){return this.theme==="dark"}toDark(){this.theme="dark",i.setValue("theme",this.theme)}toLight(){this.theme="light",i.setValue("theme",this.theme)}toggleTheme(){this.theme=this.theme==="dark"?"light":"dark",i.setValue("theme",this.theme)}}T=new WeakMap;var V;class ee{constructor(){c(this,V,h(C({})));U(this,"options",[{key:"centerTunnelUrl",name:"Synterix Service URL",desc:"synterix remote service url",placeholder:"synterix remote service url",value:"",defaultValue:"",valid(e){return!e&&!J.url.pathname.startsWith("/setting")?{result:!1,redirect:"/setting/centerTunnelUrl"}:{result:!0}},onupdate({key:e,value:t}){u.isElectronEvn()||(i.setValue(e,t),i.redirect("/")),u.request("setTunnelURL",{key:e,value:t}).then(()=>{window.location.href="/?t="+Date.now()}).catch(s=>{console.log(s)})}},{key:"theme",value:"dark",defaultValue:"dark"},{key:"token",value:"",async valid(){if(O.isPublicRoutes())return{result:!0};let{code:e,data:t}=await se.post(),s={result:e===0};return s.result?(K.username=t.user.username,K.userId=t.user.id):s.redirect="/",s}},{key:"proxies",value:[]}]);this.load()}get values(){return g(a(this,V))}set values(e){p(a(this,V),e,!0)}load(){{let e=JSON.parse(localStorage.setting||"{}");Reflect.ownKeys(e).forEach(t=>{(this.options.find(s=>s.key===t)||{}).value=e[t]}),setTimeout(()=>{this.options.forEach(t=>{this.values[t.key]=t.value})})}}save(){{let e={};this.options.forEach(t=>{e[t.key]=t.value}),localStorage.setting=JSON.stringify(e),u.request("saveSetting",localStorage.setting),this.values=e}}setValue(e,t){(this.options.find(s=>s.key===e)||{}).value=t,this.save()}hasValue(e){this.load();let t=this.options.find(s=>s.key===e);return t&&t.value}hasKey(e){return!!this.options.find(t=>t.key===e)}get(e){return this.load(),this.options.find(t=>t.key===e)}getValue(e){var t;return this.load(),(t=this.options.find(s=>s.key===e))==null?void 0:t.value}redirect(e){return A(e)}valid(){this.load();let e=!0,t="";return this.options.reduce((s,n)=>s.then(()=>{if(!e)return Promise.resolve();if(n.valid)return Promise.resolve().then(()=>n.valid(n.value)).then(({result:o,redirect:d})=>{e=o,t=d})}),Promise.resolve()).then(()=>({next:e,redirectUrl:t}))}}V=new WeakMap;var I,q;class te{constructor(){c(this,I,h(""));c(this,q,h(null))}get username(){return g(a(this,I))}set username(e){p(a(this,I),e,!0)}get userId(){return g(a(this,q))}set userId(e){p(a(this,q),e,!0)}}I=new WeakMap,q=new WeakMap;const K=new te,ue={_socket:null,get(){return this._socket||(this._socket=new Y(()=>`/synterix/gateway?token=${i.getValue("token")}`)),this._socket},async start(){let e=await(await this.get()).getClient();e.on("gtmEdgesWatch",()=>f.reload()),e.on("gtmApisWatch",()=>f.reload()),e.on("gtmEdgesState",({states:t=[]})=>{let s={};t.forEach(n=>{s[n.edgeId]=n.state===1?"Connected":"Disconnect"}),(f.data||[]).forEach(n=>{s[n.edgeId]&&(n.status=s[n.edgeId])}),f.updated=Date.now()}),R.on("edgesDone",()=>{e.sendMessage({type:"mtgEdgesState"})}),e.sendMessage({type:"mtgEdgesState"})},getClient(){return this.get().getClient()}},O={keep(...r){return r.forEach(e=>e.post()),{done(e){r.find(t=>!t.done||!t.updated)===void 0&&e&&e()}}},isPublicRoutes(){let r=J.url.pathname;return!!(r==="/"||r.startsWith("/setting"))},goto(r){A(r)}},u=new H,de=new Q(u),ce=new Z,i=new ee,se=new l("/synterix/admin/check"),he=new l("/synterix/manage/kube/desc"),ge=new l("/synterix/admin/login"),pe=new l("/synterix/admin/edge"),fe=new l("/synterix/admin/edge/update"),me=new l("/synterix/admin/edge/delete"),ye=new l("/synterix/admin/register"),we=new l("/synterix/admin/resetPwd"),ve=new l("/synterix/admin/user/remove"),ke=new l("/synterix/admin/user/list"),f=new G("/synterix/manage/clusters"),xe=new l("/synterix/admin/api"),Se=new l("/synterix/admin/api/delete"),Ee=new l("/synterix/admin/api/list"),re=new l("/synterix/manage/service/check"),N=new l("/synterix/manage/service/invoke");export{O as S,K as a,pe as b,xe as c,Se as d,fe as e,f,Ee as g,de as h,ye as i,ge as j,ue as k,ke as l,me as m,u as n,i as o,J as p,he as q,ve as r,N as s,ce as t,we as u};
