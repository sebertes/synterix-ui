var v=s=>{throw TypeError(s)};var I=(s,e,t)=>e.has(s)||v("Cannot "+t);var l=(s,e,t)=>(I(s,e,"read from private field"),t?t.call(s):e.get(s)),d=(s,e,t)=>e.has(s)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t);import{s as g,a as w,g as p,c as m}from"./QwNgEtIe.js";const f={getRandomId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},isString(s){return Object.prototype.toString.call(s)==="[object String]"},deepEqual(s,e){if(s===e)return!0;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return!1;const t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!i.includes(n)||!this.deepEqual(s[n],e[n]))return!1;return!0},copyToClipboard(s){return navigator.clipboard?navigator.clipboard.writeText(s).then(()=>!0).catch(e=>(console.error("Clipboard API 失败，回退到 execCommand:",e),this.copyByCommand(s))):this.copyByCommand(s)},copyByCommand(s){const e=document.createElement("textarea");e.value=s,e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),e.select();try{return document.execCommand("copy")}catch(t){return console.error("execCommand 错误:",t),!1}finally{document.body.removeChild(e)}},throttle(s,e,{leading:t=!1,trailing:i=!0}={}){let n=0,r=null;return function(...o){const h=Date.now();!n&&!t&&(n=h);const C=e-(h-n);C<=0?(r&&(clearTimeout(r),r=null),s.apply(this,o),n=h):i&&!r&&(r=setTimeout(()=>{s.apply(this,o),n=t?Date.now():0,r=null},C))}},isPlainObject(s){return Object.prototype.toString.call(s)==="[object Object]"},typeToString(s){return s===null||s===void 0?"--":Array.isArray(s)?"["+s.length+"]":typeof s=="object"?"{}":typeof s=="function"?s.toString():String(s)},generateUniqueString(s,e){let t=s,i=1;for(;e.includes(t);)t=`${s}${i}`,i++;return t},getBase64SizeInBytes(s){if(!s)return 0;const e=s.split(",")[1]||s;return atob(e).length},downloadAsYAML(s,e="data.yaml"){const t=new Blob([s],{type:"text/yaml"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e.endsWith(".yaml")?e:`${e}.yml`,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(i)},100)}};class E{constructor(){this._events=new Map}on(e,t){return this._events.has(e)||this._events.set(e,[]),this._events.get(e).includes(t)||this._events.get(e).push(t),this}off(e,t){return this._events.has(e)?t?(this._events.get(e).includes(t)&&this._events.get(e).splice(this._events.get(e).indexOf(t),1),this._events.get(e).length===0&&this._events.delete(e),this):(this._events.delete(e),this):this}once(e,t){const i=(...n)=>{this.off(e,i),t(...n)};return i._origin=t,this.on(e,i),this}emit(e,...t){(this._events.get(e)||[]).forEach(i=>i(...t))}removeAllListeners(e){return e?this._events.delete(e):this._events=new Map,this}}var b,y,S;class R{constructor(){d(this,b,g(w([])));d(this,y,g(null));d(this,S,g(!1))}get list(){return p(l(this,b))}set list(e){m(l(this,b),e,!0)}get active(){return p(l(this,y))}set active(e){m(l(this,y),e,!0)}get open(){return p(l(this,S))}set open(e){m(l(this,S),e,!0)}openTerm({type:e,namespace:t,podName:i,containers:n}){let r=`${e}-${i}`,o=this.list.find(h=>h.id===r);if(o){this.active=o.id;return}this.list.push({id:r,type:e,namespace:t,podName:i,containers:n}),this.active=r,this.open=!0}closeTerm(e){let t=this.list.findIndex(i=>i.id===e);t>-1&&this.list.splice(t,1),this.list.length>0?this.active=this.list[this.list.length-1].id:(this.active=null,this.open=!1)}toggleTerm(e){this.active=e}}b=new WeakMap,y=new WeakMap,S=new WeakMap;class T extends E{constructor(){super()}}var _;class L{constructor(){d(this,_,g(w([])))}get list(){return p(l(this,_))}set list(e){m(l(this,_),e,!0)}open(e,t,{top:i,delay:n=5e3}={}){let r=f.getRandomId();return this.list.push({id:r,type:e,message:t,top:i}),setTimeout(()=>this.close(r),n),r}success(e,t=5e3){this.open("success",e,{delay:t})}error(e,t=5e3){this.open("error",e,{delay:t})}update(e,{type:t,message:i}){let n=this.list.find(r=>r.id===e);n&&Object.assign(n,{type:t,message:i})}loading(e){let t=this.open("loading",e);return{id:t,success(i){this.update(t,{type:"success",message:i}),setTimeout(()=>this.close(t),5e3)},error(){this.update(t,{type:"error",message:e}),setTimeout(()=>this.close(t),5e3)}}}close(e){let t=this.list.findIndex(i=>i.id===e);t!==-1&&this.list.splice(t,1)}}_=new WeakMap;var k;class O{constructor(){d(this,k,g(w([])))}get list(){return p(l(this,k))}set list(e){m(l(this,k),e,!0)}open(e,t,i,n,r){let o=f.getRandomId();return this.list.push({id:o,title:e,component:t,options:i,width:n,height:r}),o}close(e){let t=this.list.findIndex(i=>i.id===e);t!==-1&&this.list.splice(t,1)}}k=new WeakMap;const A=new O,U=new L,j=new T,J=new R,u={subscribe:"subscribe",unsubscribe:"unsubscribe",startLog:"startLog",stopLog:"stopLog",startShell:"startShell",stopShell:"stopShell",execShell:"execShell"},a={response:"response",responseBack:"responseBack",subscribe:"subscribe",kubeWatch:"kubeWatch",gtmApisWatch:"gtmApisWatch",gtmEdgesWatch:"gtmEdgesWatch",gtmEdgesState:"gtmEdgesState"},c=new Map,M={[a.subscribe]:(s,e)=>{e.emit("subscribe",s)},[a.kubeWatch]:(s,e)=>{e.emit("kubeWatch",s)},[a.gtmApisWatch]:(s,e)=>{e.emit("gtmApisWatch",s)},[a.gtmEdgesWatch]:(s,e)=>{e.emit("gtmEdgesWatch",s)},[a.gtmEdgesState]:(s,e)=>{e.emit("gtmEdgesState",s)},[a.response]:(s,e)=>{let{id:t,code:i,msg:n}=s;i===0?c.has(t)&&(c.get(t).resolve(s.data),c.delete(t)):c.has(t)&&(c.get(t).reject(n),c.delete(t))},[a.responseBack]:(s,e)=>{let{id:t,code:i,msg:n}=s;i===0?c.has(t)&&(c.get(t).resolve(JSON.parse(s.data)),c.delete(t)):c.has(t)&&(c.get(t).reject(n),c.delete(t))}};class P extends E{constructor(e,t){super();let i="ws://localhost";i=`${window.location.protocol==="http:"?"ws:":"wss:"}//${window.location.host}`,this.host=i,this.url=e,this.options=t,this._socket=null,this._connectPromise=null,this.isManualClose=!1,this.heartbeatInterval=null,this.reconnectIntervalTimeout=5e3,this.heartbeatIntervalTimeout=1e4,this.clients=new Map}_getURL(){return`${this.host}${this.url()}`}_getPingMessage(){return{method:"ping",id:f.getRandomId(),params:{time:Date.now()}}}_reconnect(){console.log("=> Socket Reconnecting...",this.clients.size),!this._connectPromise&&setTimeout(()=>{this.emit("reconnect"),this.clients.forEach(e=>{try{e.onReconnect()}catch{}}),this._connect().catch(e=>{console.error("Socket Reconnect failed:",e),this.emit("reconnectFailed"),this.clients.forEach(t=>{try{t.onReconnectError(e)}catch{}})})},this.reconnectIntervalTimeout)}_connect(){var e;return((e=this._socket)==null?void 0:e.readyState)===WebSocket.OPEN?Promise.resolve(this._socket):(this._connectPromise||(this._connectPromise=new Promise((t,i)=>{const n=this.options?new WebSocket(this._getURL(),this.options):new WebSocket(this._getURL());n.onopen=()=>{console.log("=> Socket connected"),this.isManualClose=!1,this.heartbeatInterval=setInterval(()=>{n.readyState===WebSocket.OPEN&&n.send(JSON.stringify(this._getPingMessage()))},this.heartbeatIntervalTimeout),this.emit("connected"),this.clients.forEach(r=>{try{r.onConnected()}catch{}}),n.onclose=r=>{console.log("=> Socket closed:",r.code,r.reason),this._cleanup(),this.emit("closed",r.code),this.clients.forEach(o=>{try{o.onClosed(r)}catch{}}),this.isManualClose||this._reconnect()},n.onerror=r=>{console.error("Socket error:",r),this._cleanup(),this.emit("error",r),this.clients.forEach(o=>{try{o.onError(r)}catch{}})},n.onmessage=r=>{this.emit("message",r),this.clients.forEach(o=>{try{r.data&&o.onMessage(JSON.parse(r.data))}catch{}})},this._connectPromise=null,this._socket=n,t(n)},n.onerror=r=>{this._connectPromise=null,this._socket=null,this._cleanup(),this._reconnect(),i(r)}})),this._connectPromise)}_cleanup(){this._socket=null,clearInterval(this.heartbeatInterval)}_getClient(e){return null}async getClient(){await this._connect();let e=f.getRandomId(),t=this._getClient(e);return t&&this.clients.set(e,t),t}release(e){console.log("=> Release client:",e),this.clients.delete(e)}sendMessage(e){return this._socket&&this._socket.readyState===WebSocket.OPEN?(this._socket.send(JSON.stringify(e)),!0):!1}close(e=1e3,t="Manual close"){this.isManualClose=!0,this._connectPromise=null,this.clients.clear(),this._socket&&this._socket.close(e,t),this._cleanup()}}class D extends P{constructor(e,t){super(e,t)}_getClient(e){return new W(e,this)}}class K extends P{constructor(e,t){super(e,t)}_getPingMessage(){return{type:"ping",data:JSON.stringify({time:Date.now()})}}_getClient(e){return new B(e,this)}}class x extends E{constructor(e,t){super(),this.id=e,this.socket=t}onMessage(e){!e.type&&e.id!==void 0&&e.code!==void 0&&(e.type=a.responseBack),M[e.type]&&M[e.type](e,this)}onReconnect(){console.log(`=> Socket client[${this.id}] reconnecting`),this.emit("reconnect")}onReconnectError(e){console.error(`=> Socket client[${this.id}] Reconnect failed:`,e),this.emit("reconnectError",e)}onConnected(){console.log(`=> Socket client[${this.id}] connected`),this.emit("connected")}onClosed(){console.log(`=> Socket client[${this.id}] disconnected`),this.emit("close",null)}onError(){console.error(`Socket client[${this.id}] error:`,error),this.emit("close",error)}dispose(){this.socket.release(this.id)}sendMessage(e){return this.socket.sendMessage(e)}}class W extends x{constructor(e,t){super(e,t)}request(e,t){const i=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return this.sendMessage({id:i,method:e,params:t}),new Promise((n,r)=>{c.set(i,{resolve:n,reject:r})})}subscribe(e){return this.request(u.subscribe,e)}unsubscribe(e){return this.request(u.unsubscribe,e)}startLog(e){return this.request(u.startLog,e)}stopLog(e){return this.request(u.stopLog,{sessionId:e})}startShell(e){return this.request(u.startShell,e)}stopShell(e){return this.request(u.stopShell,{sessionId:e})}execShell(e,t){return this.request(u.execShell,{sessionId:e,command:t})}}class B extends x{constructor(e,t){super(e,t)}async request(e,t={}){return new Promise((i,n)=>{let r=f.getRandomId();c.set(r,{resolve:i,reject:n}),this.sendMessage({id:r,type:e,data:JSON.stringify({type:e,...t})})})}}export{E,D as K,K as S,f as U,J as a,j as e,A as p,U as t};
